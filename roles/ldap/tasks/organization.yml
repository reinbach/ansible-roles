---
- name: "Create organization {{ organization }}"
  ldap_entry:
    state: present
    dn: "{{ ldap_base }}"
    objectClass:
      - organization
      - dcObject
      - top
    params:
      o: "{{ organization }}"

- name: "Create organizational units for {{ organization }}"
  ldap_entry:
    state: present
    dn: "{{ item.dn }}"
    params:
      ou: "{{ item.ou }}"
    objectClass:
      - organizationalUnit
  with_items:
    - dn: "{{ ldap_dn_users_group }}"
      ou: users
    - dn: "{{ ldap_dn_admin_group }}"
      ou: admins

- name: Create users
  ldap_entry:
    state: "{{ item.state }}"
    dn: "cn={{ item.username }},{{ ldap_dn_users_group }}"
    attributes:
      sn: "{{ item.last_name }}"
    objectClass:
      - inetOrgPerson
  with_items:
    - "{{ users }}"
  no_log: true

- name: Set user password attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_users_group }}"
    state: exact
    name: userPassword
    values: "{CRYPT}{{ item.password }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present"
  no_log: true

- name: Set user email attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_users_group }}"
    state: exact
    name: mail
    values: "{{ item.email }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present"
  no_log: true

- name: Set user first name attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_users_group }}"
    state: exact
    name: givenName
    values: "{{ item.first_name }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present"
  no_log: true

- name: Set user last name attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_users_group }}"
    state: exact
    name: sn
    values: "{{ item.last_name }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present"
  no_log: true

- name: Create admin users
  ldap_entry:
    state: "{{ item.state }}"
    dn: "cn={{ item.username }},{{ ldap_dn_admin_group }}"
    attributes:
      sn: "{{ item.last_name }}"
      mail: "{{ item.email }}"
    objectClass:
      - inetOrgPerson
  with_items:
    - "{{ users }}"
  when: item.is_admin|bool
  no_log: true

- name: Set admin user password attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_admin_group }}"
    state: exact
    name: userPassword
    values: "{CRYPT}{{ item.password }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present" and item.is_admin|bool
  no_log: true

- name: Set admin user email attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_admin_group }}"
    state: exact
    name: mail
    values: "{{ item.email }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present" and item.is_admin|bool
  no_log: true

- name: Set admin user first name attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_admin_group }}"
    state: exact
    name: givenName
    values: "{{ item.first_name }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present" and item.is_admin|bool
  no_log: true

- name: Set admin user last name attribute
  ldap_attr:
    dn: "cn={{ item.username }},{{ ldap_dn_admin_group }}"
    state: exact
    name: sn
    values: "{{ item.last_name }}"
  with_items:
    - "{{ users }}"
  when: item.state == "present" and item.is_admin|bool
  no_log: true
