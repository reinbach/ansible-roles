#!/bin/bash

GITEA_BIN={{ gitea_bin }}
GITEA_CONFIG={{ gitea_config_dir }}/app.ini
GITEA_AUTH_CMD="${GITEA_BIN} --config=${GITEA_CONFIG} admin auth"
LDAP_HOST={{ gitea_ldap_host }}
LDAP_PORT={{ gitea_ldap_port }}
LDAP_USER_SEARCH_BASE={{ gitea_ldap_user_search_base }}
LDAP_BIND_DN={{ gitea_ldap_bind_dn }}
LDAP_BIND_PASSWORD='{{ gitea_ldap_bind_password }}'
ARGS=" --name=ldap --security-protocol=unencrypted --host=$LDAP_HOST --port=$LDAP_PORT --user-search-base=$LDAP_USER_SEARCH_BASE --user-filter=(&(objectClass=inetOrgPerson)(cn=%s)) --admin-filter=employeeType=admin --username-attribute=cn --email-attribute=mail --firstname-attribute=givenName --surname-attribute=sn --bind-dn=$LDAP_BIND_DN --bind-password=$LDAP_BIND_PASSWORD"

AUTH_LIST="$(sudo -u {{ gitea_user }} $GITEA_AUTH_CMD list)"
if [[ ${AUTH_LIST} == *"ldap"* ]]; then
    sudo -u {{ gitea_user }} $GITEA_AUTH_CMD update-ldap --id=1 $ARGS
else
    sudo -u {{ gitea_user }} $GITEA_AUTH_CMD add-ldap --name=ldap $ARGS
fi
